<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fetch and populate tenants
    fetch('/api/tenants')
        .then(response => response.json())
        .then(tenants => {
            const select = document.getElementById('tenantId');
            tenants.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant.TenantID;
                option.textContent = tenant.Name;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error fetching tenants:', error);
            showResult('Error fetching tenants. Please try again later.', true);
        });

    // Fetch and populate coverage types
    fetch('/api/coverage-types')
        .then(response => response.json())
        .then(coverageTypes => {
            const commissionRatesDiv = document.getElementById('commissionRates');
            coverageTypes.forEach(type => {
                const label = document.createElement('label');
                label.textContent = `${type} Commission Rate (%):`;
                const input = document.createElement('input');
                input.type = 'number';
                input.name = `commission_${type}`;
                input.min = '0';
                input.max = '100';
                input.step = '0.01';
                input.required = true;
                commissionRatesDiv.appendChild(label);
                commissionRatesDiv.appendChild(input);
            });
        })
        .catch(error => {
            console.error('Error fetching coverage types:', error);
            showResult('Error fetching coverage types. Please try again later.', true);
        });

    // Form submission
    document.getElementById('agentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const agentData = Object.fromEntries(formData.entries());

        // Separate commission rates from other data
        const commissionRates = {};
        Object.keys(agentData).forEach(key => {
            if (key.startsWith('commission_')) {
                commissionRates[key.replace('commission_', '')] = agentData[key];
                delete agentData[key];
            }
        });

        agentData.commissionRates = commissionRates;

        fetch('/api/agents', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(agentData),
        })
        .then(response => response.json())
        .then(data => {
            showResult('Agent added successfully!');
        })
        .catch(error => {
            showResult('Error adding agent: ' + error.message, true);
        });
    });
});

function showResult(message, isError = false) {
    const resultDiv = document.getElementById('result');
    resultDiv.textContent = message;
    resultDiv.className = isError ? 'error' : 'success';
}
</script>
