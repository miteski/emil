<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Agents - Insurance Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="public/css/styles.css" rel="stylesheet">
<style>
    :root {
        --primary-color: #32cccc;
        --secondary-color: #5bd7d7;
        --background-color: #ffffff;
        --text-color: #333333;
        --light-gray: #f8f9fa;
        --dark-gray: #212529;
        --success-color: #28a745;
        --danger-color: #dc3545;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        font-size: 16px;
        line-height: 1.5;
        padding-top: 120px;
        padding-bottom: 60px;
    }

    h1, h2, h3, h4, h5, h6 {
        font-family: 'Inter', sans-serif;
        font-weight: 700;
    }

    .navbar {
        background-color: var(--background-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 0.5rem;
    }

    .navbar-brand img {
        height: 40px;
    }

    .navbar-nav .nav-link {
        color: var(--text-color) !important;
        font-weight: 500;
        transition: color 0.3s ease;
        position: relative;
    }

    .navbar-nav .nav-link.active::after,
    .navbar-nav .nav-link:hover::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--primary-color);
    }

    .navbar-nav .nav-link.active,
    .navbar-nav .nav-link:hover {
        color: var(--primary-color) !important;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
    }

    .btn {
        border-radius: 4px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
    }

    .btn-primary, .btn-danger, .modal-footer .btn-primary {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: #ffffff;
    }

    .btn-primary:hover {
        background-color: #2ba3a3;
        border-color: #2ba3a3;
    }

    .btn-danger {
        background-color: var(--danger-color);
        border-color: var(--danger-color);
    }

    .input-group {
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .form-control {
        border-radius: 4px;
        border: 1px solid var(--light-gray);
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(50, 204, 204, 0.25);
    }

    .top-controls {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        background-color: var(--background-color);
        z-index: 1000;
        padding: 15px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .table-container {
        position: relative;
        overflow-y: auto;
        height: calc(100vh - 200px);
        margin-top: 60px;
        margin-bottom: 0.5rem;
    }

    .table {
        background-color: var(--background-color);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 0;
    }

    .table thead {
        position: sticky;
        top: 0;
        z-index: 2;
        background-color: var(--primary-color);
        color: white;
    }

    .table th, .table td {
        vertical-align: middle;
        text-align: center;
        padding: 0.5rem;
    }

    .table td i {
        display: block;
        margin: 0 auto 5px;
    }

    .table th:last-child,
    .table td:last-child {
        text-align: center;
    }

    .table-hover tbody tr:hover {
        background-color: var(--light-gray);
    }

    .table tbody tr.selected {
        background-color: rgba(50, 204, 204, 0.1);
    }

    .pagination-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: white;
        padding: 10px 0;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }

    .pagination .page-link {
        border-radius: 0;
        border: none;
        color: var(--primary-color);
        transition: all 0.3s ease;
        font-weight: bold;
        padding: 0.5rem 1rem;
    }

    .pagination .page-item.active .page-link {
        background-color: var(--primary-color);
        color: #ffffff;
    }

    .pagination .page-link:hover {
        background-color: var(--light-gray);
        transform: none;
    }

    .modal-content {
        border-radius: 8px;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        position: relative;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        background-color: var(--primary-color);
        color: #ffffff;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .modal-body {
        max-height: calc(90vh - 120px);
        overflow-y: auto;
        padding-bottom: 20px;
    }

    .modal-footer {
        border-top: 1px solid #dee2e6;
        position: sticky;
        bottom: 0;
        background-color: var(--background-color);
        padding: 1rem;
        display: flex;
        justify-content: flex-end;
        border-radius: 0 0 8px 8px;
    }

    .btn-close {
        background-color: rgba(255, 255, 255, 0.5);
        opacity: 1;
        padding: 0.5rem;
        border-radius: 0.25rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .btn-close:hover {
        background-color: rgba(255, 255, 255, 0.7);
        transform: scale(1.1);
    }

    .alert {
        border-radius: 4px;
    }

    .commission-rule {
        background-color: var(--light-gray);
        border-radius: 4px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    #commissionRulesForm {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    #commissionRulesFields {
        overflow-y: auto;
        flex-grow: 1;
        padding-bottom: 20px;
    }

    .commission-rule-actions {
        position: sticky;
        top: 0;
        background-color: var(--background-color);
        padding: 10px 0;
        z-index: 1;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
    }

    .table .btn-sm {
        padding: 0.25rem 0.5rem;
        border: 1px solid;
        margin: 0.1rem;
    }

    .table .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .table .btn-outline-primary:hover {
        color: #ffffff;
        background-color: var(--primary-color);
    }

    .table .btn-outline-info {
        color: #17a2b8;
        border-color: #17a2b8;
    }

    .table .btn-outline-info:hover {
        color: #ffffff;
        background-color: #17a2b8;
    }

    .table .btn-outline-success {
        color: var(--success-color);
        border-color: var(--success-color);
    }

    .table .btn-outline-success:hover {
        color: #ffffff;
        background-color: var(--success-color);
    }

    .table .btn-outline-danger {
        color: var(--danger-color);
        border-color: var(--danger-color);
    }

    .table .btn-outline-danger:hover {
        color: #ffffff;
        background-color: var(--danger-color);
    }

    .text-primary {
        color: var(--primary-color) !important;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark-gray);
    }

    .form-control, .form-select {
        color: var(--text-color);
        font-size: 0.9em;
    }

   #debugButton {
    z-index: 2000;
}

#debugInfo {
    background-color: var(--light-gray);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 2rem;
    font-family: 'Inter', sans-serif;
    display: none;
    position: fixed;
    bottom: 50px;
    right: 20px;
    max-width: 300px;
    max-height: 80vh;
    overflow-y: auto;
    z-index: 1999;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

#debugInfo h3, #debugInfo h4 {
    background-color: #e9ecef;
    padding: 0.5rem 1rem;
    margin: -1rem -1rem 1rem -1rem;
    border-radius: 8px 8px 0 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

    /* Responsive adjustments */
    @media (max-width: 768px) {
        body {
            padding-top: 180px;
        }

        .top-controls {
            padding: 10px 0;
        }

        .table-container {
            height: calc(100vh - 260px);
            margin-top: 120px;
        }

        .container {
            padding: 0 10px;
        }
    }
</style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="https://assets-global.website-files.com/5f801bd9152353d350740da6/5f84488e52cbbcea02631cbc_emillogo.svg" alt="emil logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/view-agents.html">View Agents</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/upload-csv.html">Upload Policies</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
   <div class="top-controls">
    <div class="container">
        <div class="row mb-3">
            <div class="col-md-6 d-flex align-items-center">
                <button class="btn btn-primary me-2" onclick="openAddAgentModal()">
                    <i class="bi bi-person-plus"></i> Add Agent
                </button>
                <button class="btn btn-danger" onclick="deleteSelectedAgents()">
                    <i class="bi bi-trash"></i> Delete Selected Agents
                </button>
            </div>
            <div class="col-md-6">
                <form id="searchForm" onsubmit="searchAgents(); return false;">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search by name or email">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

       <div class="table-container">
            <table id="agentsTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                        <th>Full Name</th>
                        <th>Tenant</th>
                        <th>Banking Info</th>
                        <th>Commission Rules</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="agentsTableBody">
                    <!-- Agent rows will be populated here -->
                </tbody>
            </table>
        </div>

          <div class="pagination-container">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(-1)" aria-label="Previous">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link" id="currentPage">1</span>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(1)" aria-label="Next">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Basic Info Modal -->
         <div class="modal fade" id="basicInfoModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="basicInfoModalTitle">Agent Basic Info</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="basicInfoForm">
                            <input type="hidden" id="agentId">
                            <div class="mb-3">
                                <label for="fullname" class="form-label">Full Name:</label>
                                <input type="text" class="form-control" id="fullname" name="fullname" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email:</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="tenantId" class="form-label">Tenant:</label>
                                <select class="form-select" id="tenantId" name="tenantId" required>
                                    <option value="">Select Tenant</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" form="basicInfoForm" class="btn btn-primary">Save Basic Info</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Banking Info Modal -->
         <div class="modal fade" id="bankingInfoModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Agent Banking Info</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="bankingInfoForm">
                            <input type="hidden" id="bankingAgentId">
                            <div class="mb-3">
                                <label for="bankName" class="form-label">Bank Name:</label>
                                <input type="text" class="form-control" id="bankName" name="bankName" required>
                            </div>
                            <div class="mb-3">
                                <label for="iban" class="form-label">IBAN:</label>
                                <input type="text" class="form-control" id="iban" name="iban" required>
                            </div>
                            <div class="mb-3">
                                <label for="bic" class="form-label">BIC:</label>
                                <input type="text" class="form-control" id="bic" name="bic" required>
                            </div>
                            <div class="mb-3">
                                <label for="accountHolderName" class="form-label">Account Holder Name:</label>
                                <input type="text" class="form-control" id="accountHolderName" name="accountHolderName" required>
                            </div>
                            <div class="mb-3">
                                <label for="paymentMethod" class="form-label">Payment Method:</label>
                                <input type="text" class="form-control" id="paymentMethod" name="paymentMethod" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" form="bankingInfoForm" class="btn btn-primary">Save Banking Info</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Commission Rules Modal -->
   <div class="modal fade" id="commissionRulesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agent Commission Rules</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="commissionRulesForm">
                    <input type="hidden" id="commissionAgentId">
                    <div class="commission-rule-actions">
                        <button type="button" class="btn btn-secondary" onclick="addCommissionRule()">Add Rule</button>
                    </div>
                    <div id="commissionRulesFields">
                        <!-- Commission rules will be added here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="commissionRulesForm" class="btn btn-primary">Save Commission Rules</button>
            </div>
        </div>
    </div>
</div>

      <button class="btn btn-sm btn-secondary position-fixed bottom-0 end-0 m-3" onclick="toggleDebugInfo()">
        <i class="bi bi-bug"></i>
    </button>
    <div id="debugInfo" class="container mt-4"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let currentPage = 1;
    const pageSize = 10;
    let lastError = '';
    let coverages = [];

    function fetchAgents(page, search = '') {
        console.log(`Fetching agents for page ${page}, search: "${search}"`);
        fetch(`/api/agents?page=${page}&pageSize=${pageSize}&search=${search}`)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Agents data received:', data);
                const tableBody = document.getElementById('agentsTableBody');
                tableBody.innerHTML = '';
                if (data.agents && data.agents.length > 0) {
                    data.agents.forEach(agent => {
                        const row = `<tr>
                            <td><input type="checkbox" class="agentCheckbox" value="${agent.AgentID}"></td>
                            <td>${agent.Fullname}</td>
                            <td>${agent.TenantName || 'N/A'}</td>
                            <td>${agent.hasBankingInfo ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle-fill text-danger"></i>'}</td>
                            <td>${agent.hasCommissionRules ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle-fill text-danger"></i>'}</td>
                           <td>
                                <div class="btn-group" role="group" aria-label="Agent actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editBasicInfo(${agent.AgentID})" data-bs-toggle="tooltip" title="Edit Basic Info">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="editBankingInfo(${agent.AgentID})" data-bs-toggle="tooltip" title="Edit Banking Info">
                                        <i class="bi bi-bank"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="editCommissionRules(${agent.AgentID})" data-bs-toggle="tooltip" title="Edit Commission Rules">
                                        <i class="bi bi-percent"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAgent(${agent.AgentID})" data-bs-toggle="tooltip" title="Delete Agent">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    </div>
                                </td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    });
                    initTooltips();
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No agents found</td></tr>';
                }
                document.getElementById('currentPage').textContent = page;
                document.getElementById('errorMessage').style.display = 'none';
                lastError = '';
            })
            .catch(error => {
                console.error('Error fetching agents:', error);
                document.getElementById('agentsTableBody').innerHTML = '<tr><td colspan="6" class="text-center">Failed to load records</td></tr>';
                document.getElementById('errorMessage').textContent = 'Failed to load records';
                document.getElementById('errorMessage').style.display = 'block';
                lastError = error.message;
                updateDebugInfo();
            });
    }

    function searchAgents() {
        const searchTerm = document.getElementById('searchInput').value;
        currentPage = 1;
        fetchAgents(currentPage, searchTerm);
        return false; // Prevent form submission
    }

    function clearSearch() {
        document.getElementById('searchInput').value = '';
        currentPage = 1;
        fetchAgents(currentPage);
    }

    function changePage(delta) {
        currentPage += delta;
        if (currentPage < 1) currentPage = 1;
        const searchTerm = document.getElementById('searchInput').value;
        fetchAgents(currentPage, searchTerm);
    }

    function openAddAgentModal() {
        document.getElementById('basicInfoModalTitle').textContent = 'Add Agent';
        document.getElementById('agentId').value = '';
        document.getElementById('basicInfoForm').reset();
        new bootstrap.Modal(document.getElementById('basicInfoModal')).show();
    }

    function editBasicInfo(agentId) {
        fetch(`/api/agents/${agentId}`)
            .then(response => response.json())
            .then(agent => {
                document.getElementById('basicInfoModalTitle').textContent = 'Edit Agent Basic Info';
                document.getElementById('agentId').value = agent.AgentID;
                document.getElementById('fullname').value = agent.Fullname;
                document.getElementById('email').value = agent.Email;
                document.getElementById('tenantId').value = agent.TenantID;
                new bootstrap.Modal(document.getElementById('basicInfoModal')).show();
            })
            .catch(error => console.error('Error fetching agent details:', error));
    }

    function editBankingInfo(agentId) {
        fetch(`/api/agents/${agentId}/banking-info`)
            .then(response => response.json())
            .then(bankingInfo => {
                document.getElementById('bankingAgentId').value = agentId;
                document.getElementById('bankName').value = bankingInfo.BankName || '';
                document.getElementById('iban').value = bankingInfo.IBAN || '';
                document.getElementById('bic').value = bankingInfo.BIC || '';
                document.getElementById('accountHolderName').value = bankingInfo.AccountHolderName || '';
                document.getElementById('paymentMethod').value = bankingInfo.PaymentMethod || '';
                new bootstrap.Modal(document.getElementById('bankingInfoModal')).show();
            })
            .catch(error => {
                console.error('Error fetching banking info:', error);
                alert('Failed to fetch banking information. Please try again.');
            });
    }

    function editCommissionRules(agentId) {
        fetch(`/api/agents/${agentId}/commission-rules`)
            .then(response => response.json())
            .then(commissionRules => {
                const commissionRulesFields = document.getElementById('commissionRulesFields');
                commissionRulesFields.innerHTML = '';
                document.getElementById('commissionAgentId').value = agentId;
                
                if (commissionRules.length === 0) {
                    addCommissionRule();
                } else {
                    commissionRules.forEach(rule => addCommissionRule(rule));
                }
                
                new bootstrap.Modal(document.getElementById('commissionRulesModal')).show();
            })
            .catch(error => console.error('Error fetching commission rules:', error));
    }

    function addCommissionRule(rule = null) {
        const commissionRulesFields = document.getElementById('commissionRulesFields');
        const ruleDiv = document.createElement('div');
        ruleDiv.className = 'commission-rule';
        ruleDiv.innerHTML = `
            <div class="row g-3">
                <div class="col-md-6">
                    <select name="CoverageID" class="form-select" required>
                        <option value="">Select Coverage</option>
                        ${coverages.map(coverage => `<option value="${coverage.CoverageID}"${rule && rule.CoverageID === coverage.CoverageID ? ' selected' : ''}>${coverage.CoverageDescription}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-6">
                    <input type="number" name="Premium_Commission_Percentage" class="form-control" placeholder="Commission from Premium (%)" step="0.01" min="0" max="100" required value="${rule ? rule.Premium_Commission_Percentage : ''}">
                </div>
                <div class="col-md-6">
                    <input type="number" name="Percentage_In_Advance" class="form-control" placeholder="Portion paid in Advance (%)" step="0.01" min="0" max="100" required value="${rule ? rule.Percentage_In_Advance : ''}">
                </div>
                <div class="col-md-6">
                    <input type="number" name="Percentage_On_Installments" class="form-control" placeholder="Portion paid with Installments (%)" step="0.01" min="0" max="100" required value="${rule ? rule.Percentage_On_Installments : ''}">
                </div>
                <div class="col-md-6">
                    <input type="date" name="StartDate" class="form-control" required value="${rule ? rule.StartDate.split('T')[0] : ''}">
                </div>
                <div class="col-md-6">
                    <input type="date" name="EndDate" class="form-control" required value="${rule ? rule.EndDate.split('T')[0] : ''}">
                </div>
                <div class="col-12">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.commission-rule').remove()">Remove Rule</button>
                </div>
            </div>
        `;
        commissionRulesFields.appendChild(ruleDiv);
    }

    function deleteAgent(agentId) {
        if (confirm('Are you sure you want to delete this agent?')) {
            fetch(`/api/agents/${agentId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    fetchAgents(currentPage);
                })
                .catch(error => console.error('Error deleting agent:', error));
        }
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.getElementsByClassName('agentCheckbox');
        for (let checkbox of checkboxes) {
            checkbox.checked = selectAll.checked;
        }
    }

    function deleteSelectedAgents() {
        const selectedAgents = Array.from(document.getElementsByClassName('agentCheckbox'))
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        if (selectedAgents.length === 0) {
            alert('No agents selected');
            return;
        }

        if (confirm(`Are you sure you want to delete ${selectedAgents.length} agent(s)?`)) {
            fetch('/api/agents/bulk-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ agentIds: selectedAgents }),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                fetchAgents(currentPage);
            })
            .catch(error => console.error('Error deleting agents:', error));
        }
    }

    document.getElementById('basicInfoForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const agentId = document.getElementById('agentId').value;
        const formData = new FormData(this);
        const agentData = Object.fromEntries(formData.entries());

        const url = agentId ? `/api/agents/${agentId}` : '/api/agents';
        const method = agentId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(agentData),
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('basicInfoModal')).hide();
            fetchAgents(currentPage);
        })
        .catch(error => console.error('Error saving agent:', error));
    });

    document.getElementById('bankingInfoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const agentId = document.getElementById('bankingAgentId').value;
        const formData = new FormData(this);
        const bankingData = Object.fromEntries(formData.entries());

        fetch(`/api/agents/${agentId}/banking-info`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(bankingData),
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('bankingInfoModal')).hide();
            fetchAgents(currentPage);
        })
        .catch(error => console.error('Error saving banking info:', error));
    });

    document.getElementById('commissionRulesForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const agentId = document.getElementById('commissionAgentId').value;
        const rules = Array.from(this.querySelectorAll('.commission-rule')).map(ruleDiv => {
            const rule = {};
            ruleDiv.querySelectorAll('select, input').forEach(input => {
                rule[input.name] = input.value;
            });
            return rule;
        });

        fetch(`/api/agents/${agentId}/commission-rules`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(rules),
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('commissionRulesModal')).hide();
            fetchAgents(currentPage);
        })
        .catch(error => console.error('Error saving commission rules:', error));
    });

function toggleDebugInfo() {
    const debugInfo = document.getElementById('debugInfo');
    const debugButton = document.getElementById('debugButton');
    if (debugInfo.style.display === 'none') {
        debugInfo.style.display = 'block';
        updateDebugInfo();
        debugButton.textContent = 'Hide Debug';
    } else {
        debugInfo.style.display = 'none';
        debugButton.textContent = 'Debug';
    }
}

function updateDebugInfo() {
    const debugInfo = document.getElementById('debugInfo');
    const windowSize = `Window size: ${window.innerWidth}x${window.innerHeight}`;
    const scrollPosition = `Scroll position: ${window.pageXOffset}x${window.pageYOffset}`;
    const tableContainerInfo = getElementInfo('table-container');
    const topControlsInfo = getElementInfo('top-controls');
    const paginationInfo = getElementInfo('pagination-container');

    debugInfo.innerHTML = `
        <h3>Debug Information</h3>
        <p>${windowSize}</p>
        <p>${scrollPosition}</p>
        <p>Current Page: ${currentPage}</p>
        <p>Page Size: ${pageSize}</p>
        <p>Search Term: ${document.getElementById('searchInput').value}</p>
        <p>Last API Call: ${new Date().toLocaleString()}</p>
        <p>Last Error: ${lastError}</p>
        <h4>Element Information:</h4>
        <p>Table Container: ${tableContainerInfo}</p>
        <p>Top Controls: ${topControlsInfo}</p>
        <p>Pagination: ${paginationInfo}</p>
    `;
}

function getElementInfo(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return 'Not found';
    const rect = element.getBoundingClientRect();
    return `Position: (${rect.left}, ${rect.top}), Size: ${rect.width}x${rect.height}`;
}

// Call this function whenever the window is resized
window.addEventListener('resize', updateDebugInfo);

// Call this function after loading the agents
function afterLoadingAgents() {
    updateDebugInfo();
    // ... any other code you want to run after loading agents
}

    function initTooltips() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    }

    // Initial fetch
    fetchAgents(currentPage);

    // Fetch tenants for the dropdown
    fetch('/api/tenants')
        .then(response => response.json())
        .then(tenants => {
            const select = document.getElementById('tenantId');
            tenants.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant.TenantID;
                option.textContent = tenant.Name;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error fetching tenants:', error));

    // Fetch coverages
    fetch('/api/coverages')
        .then(response => response.json())
        .then(data => {
            coverages = data;
        })
        .catch(error => console.error('Error fetching coverages:', error));
    </script>
   
    <button id="debugButton" class="btn btn-sm btn-secondary position-fixed bottom-0 end-0 m-3" onclick="toggleDebugInfo()">
    <i class="bi bi-bug"></i> Debug
</button>
<div id="debugInfo" class="container mt-4"></div>
    
</body>
</html>
